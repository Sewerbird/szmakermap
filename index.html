<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style type="text/css">
    body, html,#map {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
  </style>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=r9U9wyyvxi6tLfKmQsmpLYS2syCxAzi2"></script>
  <title>Shenzhen Makers Map</title>
</head>
<body>
  <div id="map" style="width: 100vw; height:100vh;"></div>
<script type="text/javascript">

  var locale = 'en';

  // init map
  var map = new BMap.Map("map");
  map.centerAndZoom(new BMap.Point(113.93,22.54), 13);
  map.addControl(new BMap.MapTypeControl());
  map.addControl(new BMap.GeolocationControl());
  map.addControl(new BMap.ScaleControl());

  // map.addControl(new BMap.OverviewMapControl());
  var navCtrl = new BMap.NavigationControl({type: BMAP_NAVIGATION_CONTROL_ZOOM});
  navCtrl.setAnchor(BMAP_ANCHOR_TOP_RIGHT);
  navCtrl.setOffset(new BMap.Size(20, 50));
  map.addControl(navCtrl);

  map.setCurrentCity("深圳");
  map.enablePinchToZoom(true);
  map.enableKeyboard(true);
  map.enableDoubleClickZoom(true);
  map.enableScrollWheelZoom(true);

  // load data
  loadJSON("list.json", function(response) {
    var data = JSON.parse(response);
    console.log('data loaded');
    console.log(data);

    // add points to the map
    var markers = data.forEach(f => {

      // default to chinese address
      var address = f.properties[locale].address || f.properties['zh'].address

      var opts = {
        width : 400,
        height: 200
      }

      var content = `<h3>${f.properties[locale].name}</h3>`
      content += `<p>${f.properties[locale].description}</p>`
      content += `<p>${address}</p>`

      var infoWindow = new BMap.InfoWindow(content, opts);


      if (f.geometry.type === 'Point') {

        var point = new BMap.Point(f.geometry.coordinates[0], f.geometry.coordinates[1])

        // create and show marker on the map
        var marker = new BMap.Marker(point)
        map.addOverlay(marker)

      } else if (f.geometry.type === 'Polygon') {
        console.log('draw polygon');

        // add point for visibility
        var points = f.geometry.coordinates.map(c => new BMap.Point(c[0], c[1]) )
        var point = points[0]

        // create polygon
        var polygonOptions = {
          strokeColor : '#00C96F',
          fillColor : '#00C96F',
          fillOpacity : .6
        }
        var marker = new BMap.Polygon(points, polygonOptions)
        map.addOverlay(marker)

      } else {
        return // prevent adding unknown geometries
      }

      marker.addEventListener("click", function(){
        map.openInfoWindow(infoWindow, point); //开启信息窗口
      });




    })
  })


  /**
   * Helper function to load JSON file
   * @param  String fileName Name of the file to fetch
   * @param  {Function} callback [description]
   * @return response data fetched from XMLHttpRequest
   */
  function loadJSON(fileName, callback) {
    var xobj = new XMLHttpRequest();
     xobj.overrideMimeType("application/json");
     xobj.open('GET', fileName, true);
     xobj.onreadystatechange = function () {
           if (xobj.readyState == 4 && xobj.status == "200") {
             callback(xobj.responseText);
           }
     };
     xobj.send(null);
  }



</script>
</body>
</html>
